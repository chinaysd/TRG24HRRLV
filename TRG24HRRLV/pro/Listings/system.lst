C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN .\Objects\system.obj
COMPILER INVOKED BY: E:\MDK\C51\BIN\C51.EXE ..\user\system.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\bsp\key;..\bsp;..\lib;..
                    -\TimeOut;..\user) DEBUG OBJECTEXTEND PRINT(.\Listings\system.lst) OBJECT(.\Objects\system.obj)

line level    source

   1          #include "system.h"
   2          
   3          TIMEOUT_PARA TimeOut_Para[2];
   4          unsigned char Data;
   5          unsigned char App_Flag;
   6          
   7          /************************发热布变量定义*************************************/
   8          unsigned char Heat_Flag;
   9          unsigned int  Heat_Cnt;
  10          unsigned char Heat_Cnt30Min_Flag;
  11          unsigned int  Heat_Cnt30Min;
  12          unsigned int  App_Heat_Cnt1s;
  13          /***************************************************************************/
  14          
  15          /************************马达变量定义***************************************/
  16          unsigned char Mass_Flag;
  17          unsigned int  Mass_Cnt;
  18          unsigned char Mass_Cnt30Min_Flag;
  19          unsigned int  Mass_Cnt30Min;
  20          unsigned int  App_Mass_Cnt1s;
  21          /***************************************************************************/
  22          
  23          /************************脚灯变量定义***************************************/
  24          unsigned char Foot_Led_Flag;
  25          unsigned int  Foot_Led_Cnt;
  26          /***************************************************************************/
  27          void Key_Handle(unsigned char Get_Key)
  28          {  
  29   1          /*****************************************************************************************************
             -*************************************/
  30   1          /**************************************************************马达、发热布、脚灯、双推***************
             -*************************************/ 
  31   1          /*****************************************************************************************************
             -*************************************/ 
  32   1          if(TEST_PIN == 1)
  33   1          {
  34   2              if(Get_Key == MSG_KEY_NONE)
  35   2              {
  36   3                 Rev_Data_Handle();
  37   3                 if(!App_Flag)
  38   3                 {
  39   4                    Data = STOP;  
  40   4                 }
  41   3                 Mass_Flag     = 0;
  42   3                 Heat_Flag     = 0;
  43   3                 Foot_Led_Flag = 0;
  44   3              }
  45   2              else if(Get_Key == MSG_KEY1_LONGPRESS)//K7
  46   2              {
  47   3                 App_Flag  = 0;
  48   3                 Data = HEAD_UP;        
  49   3              }
  50   2              else if(Get_Key == MSG_KEY2_LONGPRESS)//K5
  51   2              {
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 2   

  52   3                 App_Flag  = 0;
  53   3                 Data = HEAD_DOWN;     
  54   3              }
  55   2              else if(Get_Key == MSG_KEY3_LONGPRESS)//K4
  56   2              {
  57   3                 App_Flag  = 0;
  58   3                 Data = CLOSE;         
  59   3              }
  60   2              else if(Get_Key == MSG_KEY4_LONGPRESS)//K6
  61   2              {
  62   3                 App_Flag  = 0;
  63   3                 Data = OPEN;               
  64   3              }
  65   2              else if(Get_Key == MSG_KEY5_LONGPRESS_HD)//K1
  66   2              {
  67   3                 App_Flag  = 0;
  68   3                 Data = HOME_POSITION;         
  69   3              }
  70   2              else if(Get_Key == MSG_KEY6_PRESS)//K2
  71   2              {
  72   3                 
  73   3                  if(!Mass_Flag)
  74   3                  {
  75   4                     App_Flag  = 1;
  76   4                     Mass_Flag = 1;
  77   4                     ++ Mass_Cnt;
  78   4                     if(Mass_Cnt & 0x01)
  79   4                     {
  80   5                        Mass_Cnt30Min_Flag = True;
  81   5                        Mass_Cnt30Min = 0;          //计数清0
  82   5                        App_Mass_Cnt1s = 0;         //计数清0
  83   5                        Data = MASS_OPEN; 
  84   5                        LED1_SET(0);                  
  85   5                     }   
  86   4                     else
  87   4                     {
  88   5                        Mass_Cnt30Min_Flag = False;
  89   5                        Data = MASS_CLOSE;  
  90   5                        LED1_SET(0);                
  91   5                     }               
  92   4                  } 
  93   3                   #if 0
                          if(!Foot_Led_Flag)
                          {
                             App_Flag  = 1;
                             Foot_Led_Flag = 1;
                             ++ Foot_Led_Cnt;
                             if(Foot_Led_Cnt & 0x01)
                             {
                                Data = FOOT_LIGHT_OPEN; 
                             }
                             else 
                             {
                                Data = FOOT_LIGHT_CLOSE; 
                             }
                          } 
                          #endif             
 109   3              }
 110   2              else if(Get_Key == MSG_KEY7_PRESS)//K3
 111   2              {
 112   3                 if(!Heat_Flag)
 113   3                 {
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 3   

 114   4                     App_Flag  = 1;
 115   4                     Heat_Flag = 1;
 116   4                     ++ Heat_Cnt;
 117   4                     if(Heat_Cnt & 0x01)
 118   4                     {
 119   5                       App_Heat_Cnt1s = 0; 
 120   5                       Heat_Cnt30Min  = 0;
 121   5                       Heat_Cnt30Min_Flag = True;
 122   5                       Data = HEAT_ON;
 123   5                       LED2_SET(1);               
 124   5                     }
 125   4                     else
 126   4                     {
 127   5                       Heat_Cnt30Min_Flag = False;  
 128   5                       Data = HEAT_OFF;
 129   5                       LED2_SET(0); 
 130   5                     }
 131   4                 }            
 132   3              }
 133   2              #if 1
 134   2              else if(Get_Key == MSG_KEY5_SHORT_PRESS)
 135   2              {
 136   3                  if(!Foot_Led_Flag)
 137   3                  {
 138   4                     App_Flag  = 1;
 139   4                     Foot_Led_Flag = 1;
 140   4                     ++ Foot_Led_Cnt;
 141   4                     if(Foot_Led_Cnt & 0x01)
 142   4                     {
 143   5                        Data = FOOT_LIGHT_OPEN; 
 144   5                     }
 145   4                     else 
 146   4                     {
 147   5                        Data = FOOT_LIGHT_CLOSE; 
 148   5                     }
 149   4                  }
 150   3              }
 151   2              #endif
 152   2          }        
 153   1          /*****************************************************************************************************
             -*************************************/
 154   1          /**************************************************************三推，脚灯/复位按键复用****************
             -************************************/ 
 155   1          /*****************************************************************************************************
             -*************************************/ 
 156   1          else
 157   1          {
 158   2              if(Get_Key == MSG_KEY_NONE)
 159   2              {
 160   3                 Rev_Data_Handle();
 161   3                 if(!App_Flag)
 162   3                 {
 163   4                    Data = STOP;  
 164   4                 }
 165   3                 Mass_Flag     = 0;
 166   3                 Heat_Flag     = 0;
 167   3                 Foot_Led_Flag = 0;
 168   3              }
 169   2              else if(Get_Key == MSG_KEY1_LONGPRESS)//K7
 170   2              {
 171   3                 App_Flag  = 0;
 172   3                 Data = HEAD_DOWN;        
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 4   

 173   3              }
 174   2              else if(Get_Key == MSG_KEY2_LONGPRESS)//K5
 175   2              {
 176   3                 App_Flag  = 0;
 177   3                 Data = HEAD_UP;     
 178   3              }
 179   2              else if(Get_Key == MSG_KEY3_LONGPRESS)//K4
 180   2              {
 181   3                 App_Flag  = 0;
 182   3                 Data = OPEN;         
 183   3              }
 184   2              else if(Get_Key == MSG_KEY4_LONGPRESS)//K6
 185   2              {
 186   3                 App_Flag  = 0;
 187   3                 Data = CLOSE;               
 188   3              }
 189   2              else if(Get_Key == MSG_KEY5_LONGPRESS_HD)//K1
 190   2              {
 191   3                 App_Flag  = 0;
 192   3                 Data = HOME_POSITION;         
 193   3              }
 194   2              else if(Get_Key == MSG_KEY6_PRESS)//K2
 195   2              {
 196   3                 if(!Heat_Flag)
 197   3                 {
 198   4                     App_Flag  = 1;
 199   4                     Heat_Flag = 1;
 200   4                     ++ Heat_Cnt;
 201   4                     if(Heat_Cnt & 0x01)
 202   4                     {
 203   5                       App_Heat_Cnt1s = 0; 
 204   5                       Heat_Cnt30Min  = 0;
 205   5                       Heat_Cnt30Min_Flag = True;
 206   5                       Data = HEAT_ON;
 207   5                       LED1_SET(1);               
 208   5                     }
 209   4                     else
 210   4                     {
 211   5                       Heat_Cnt30Min_Flag = False;  
 212   5                       Data = HEAT_OFF;
 213   5                       LED1_SET(0); 
 214   5                     }
 215   4                 }             
 216   3              }
 217   2              else if(Get_Key == MSG_KEY7_PRESS)//K3
 218   2              {
 219   3                 if(!Mass_Flag)
 220   3                  {
 221   4                     App_Flag  = 1;
 222   4                     Mass_Flag = 1;
 223   4                     ++ Mass_Cnt;
 224   4                     if(Mass_Cnt & 0x01)
 225   4                     {
 226   5                        Mass_Cnt30Min_Flag = True;
 227   5                        Mass_Cnt30Min = 0;          //计数清0
 228   5                        App_Mass_Cnt1s = 0;         //计数清0
 229   5                        Data = MASS_OPEN; 
 230   5                        LED2_SET(0);                  
 231   5                     }   
 232   4                     else
 233   4                     {
 234   5                        Mass_Cnt30Min_Flag = False;
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 5   

 235   5                        Data = MASS_CLOSE;  
 236   5                        LED2_SET(0);                
 237   5                     }               
 238   4                  } 
 239   3                   #if 0
                          if(!Foot_Led_Flag)
                          {
                             App_Flag  = 1;
                             Foot_Led_Flag = 1;
                             ++ Foot_Led_Cnt;
                             if(Foot_Led_Cnt & 0x01)
                             {
                                Data = FOOT_LIGHT_OPEN; 
                             }
                             else 
                             {
                                Data = FOOT_LIGHT_CLOSE; 
                             }
                          } 
                          #endif            
 255   3              }
 256   2              else if(Get_Key == MSG_KEY5_SHORT_PRESS)
 257   2              {
 258   3                  if(!Foot_Led_Flag)
 259   3                  {
 260   4                     App_Flag  = 1;
 261   4                     Foot_Led_Flag = 1;
 262   4                     ++ Foot_Led_Cnt;
 263   4                     if(Foot_Led_Cnt & 0x01)
 264   4                     {
 265   5                        Data = FOOT_LIGHT_OPEN; 
 266   5                     }
 267   4                     else 
 268   4                     {
 269   5                        Data = FOOT_LIGHT_CLOSE; 
 270   5                     }
 271   4                  }
 272   3              }
 273   2          }
 274   1      }
 275          
 276          
 277          void System_Init(void)
 278          {
 279   1        TimeOutDet_Init();
 280   1        Timer_Init();
 281   1        Uart_Init(9600);
 282   1        Led_App_Handle(LED_NUM);
 283   1        Test_Init();
 284   1        Key_Init();
 285   1        Key_Register(Key_Handle);
 286   1        WDTCON |= 0X40;
 287   1        EA = 1;
 288   1      }
 289          
 290          void System_Handle(void)
 291          {
 292   1         WDTCON |= 0X40;
 293   1         Key_Poll();
 294   1         if(TimeOutDet_Check(&TimeOut_Para[0]))
 295   1         {
 296   2            TimeOut_Record(&TimeOut_Para[0],OnLine_Time); 
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 6   

 297   2            Protocol_Send(SEND_ADDR,SEND_ID,Data);         
 298   2         }
 299   1      }
 300          
 301          /**************************************************
 302          *函数名称：void timer0/1/2() interrupt 1/3/5
 303          *函数功能：定时器中断产生方波
 304          *入口参数：void
 305          *出口参数：void
 306          **************************************************/
 307          void timer0() interrupt 1
 308          {
 309   1        extern unsigned int Mass_Cnt;
 310   1        extern unsigned int Heat_Cnt;
 311   1        extern unsigned int Foot_Led_Cnt;
 312   1        TL0 = (65536 - 6000)%256;
 313   1        TH0 = (65536 - 6000)/256;
 314   1        TimeOutDet_DecHandle();
 315   1        /***********************马达定时关闭*************************/
 316   1        if(Mass_Cnt30Min_Flag)
 317   1        {
 318   2           App_Mass_Cnt1s ++; 
 319   2        }      
 320   1        if(App_Mass_Cnt1s > 1000)
 321   1        {
 322   2           App_Mass_Cnt1s = 0;
 323   2           Mass_Cnt30Min ++;      
 324   2        }
 325   1        if(Mass_Cnt30Min > 1800)
 326   1        {
 327   2           Mass_Cnt30Min = 0; 
 328   2           App_Mass_Cnt1s = 0;     
 329   2           Mass_Cnt30Min_Flag = False;
 330   2           Data = MASS_CLOSE;  
 331   2           LED2_SET(0);
 332   2           Mass_Cnt = 0;
 333   2        }
 334   1        /**************************发热布定时关闭************************************/
 335   1        if(Heat_Cnt30Min_Flag)
 336   1        {
 337   2          App_Heat_Cnt1s ++; 
 338   2        }
 339   1        if(App_Heat_Cnt1s > 1000)
 340   1        {
 341   2           App_Heat_Cnt1s = 0; 
 342   2           Heat_Cnt30Min ++;
 343   2        }
 344   1        if(Heat_Cnt30Min > 1800)
 345   1        {
 346   2           App_Heat_Cnt1s = 0; 
 347   2           Heat_Cnt30Min  = 0;
 348   2           Heat_Cnt30Min_Flag = False;
 349   2           Data = HEAT_OFF;
 350   2           LED1_SET(0); 
 351   2           Heat_Cnt = 0;
 352   2        }
 353   1        
 354   1      }
 355          
 356          void timer1() interrupt 3
 357          {
 358   1      
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 16:54:41 PAGE 7   

 359   1      }
 360          
 361          void Timer2Int(void) interrupt 5
 362          {               
 363   1              TF2 = 0;   //溢出清零
 364   1       
 365   1      }
 366          
 367          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    758    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     37       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
