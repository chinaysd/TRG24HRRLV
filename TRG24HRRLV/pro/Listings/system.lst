C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 15:21:34 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN .\Objects\system.obj
COMPILER INVOKED BY: E:\MDK\C51\BIN\C51.EXE ..\user\system.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\bsp\key;..\bsp;..\lib;..
                    -\TimeOut;..\user) DEBUG OBJECTEXTEND PRINT(.\Listings\system.lst) OBJECT(.\Objects\system.obj)

line level    source

   1          #include "system.h"
   2          
   3          TIMEOUT_PARA TimeOut_Para[2];
   4          unsigned char Data;
   5          unsigned char App_Flag;
   6          
   7          /************************发热布变量定义*************************************/
   8          unsigned char Heat_Flag;
   9          unsigned int  Heat_Cnt;
  10          unsigned char Heat_Cnt30Min_Flag;
  11          unsigned int  Heat_Cnt30Min;
  12          unsigned int  App_Heat_Cnt1s;
  13          /***************************************************************************/
  14          
  15          /************************马达变量定义***************************************/
  16          unsigned char Mass_Flag;
  17          unsigned int  Mass_Cnt;
  18          unsigned char Mass_Cnt30Min_Flag;
  19          unsigned int  Mass_Cnt30Min;
  20          unsigned int  App_Mass_Cnt1s;
  21          /***************************************************************************/
  22          
  23          /************************脚灯变量定义***************************************/
  24          unsigned char Foot_Led_Flag;
  25          unsigned int  Foot_Led_Cnt;
  26          /***************************************************************************/
  27          void Key_Handle(unsigned char Get_Key)
  28          {  
  29   1          /*****************************************************************************************************
             -*************************************/
  30   1          /**************************************************************马达、发热布、脚灯、双推***************
             -*************************************/ 
  31   1          /*****************************************************************************************************
             -*************************************/ 
  32   1          if(TEST_PIN == 1)
  33   1          {
  34   2              if(Get_Key == MSG_KEY_NONE)
  35   2              {
  36   3                 Rev_Data_Handle();
  37   3                 if(!App_Flag)
  38   3                 {
  39   4                    Data = STOP;  
  40   4                 }
  41   3                 Mass_Flag     = 0;
  42   3                 Heat_Flag     = 0;
  43   3                 Foot_Led_Flag = 0;
  44   3              }
  45   2              else if(Get_Key == MSG_KEY1_LONGPRESS)//K7
  46   2              {
  47   3                 App_Flag  = 0;
  48   3                 Data = HEAD_UP;        
  49   3              }
  50   2              else if(Get_Key == MSG_KEY2_LONGPRESS)//K5
  51   2              {
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 15:21:34 PAGE 2   

  52   3                 App_Flag  = 0;
  53   3                 Data = HEAD_DOWN;     
  54   3              }
  55   2              else if(Get_Key == MSG_KEY3_LONGPRESS)//K4
  56   2              {
  57   3                 App_Flag  = 0;
  58   3                 Data = CLOSE;         
  59   3              }
  60   2              else if(Get_Key == MSG_KEY4_LONGPRESS)//K6
  61   2              {
  62   3                 App_Flag  = 0;
  63   3                 Data = OPEN;               
  64   3              }
  65   2              else if(Get_Key == MSG_KEY5_LONGPRESS_HD)//K1
  66   2              {
  67   3                 App_Flag  = 0;
  68   3                 Data = HOME_POSITION;         
  69   3              }
  70   2              else if(Get_Key == MSG_KEY6_PRESS)//K2
  71   2              {
  72   3                  #if 0
                          if(!Mass_Flag)
                          {
                             App_Flag  = 1;
                             Mass_Flag = 1;
                             ++ Mass_Cnt;
                             if(Mass_Cnt & 0x01)
                             {
                                Mass_Cnt30Min_Flag = True;
                                Mass_Cnt30Min = 0;          //计数清0
                                App_Mass_Cnt1s = 0;         //计数清0
                                Data = MASS_OPEN; 
                                LED1_SET(0);                  
                             }   
                             else
                             {
                                Mass_Cnt30Min_Flag = False;
                                Data = MASS_CLOSE;  
                                LED1_SET(0);                
                             }               
                          } 
                          #endif 
  94   3                  if(!Foot_Led_Flag)
  95   3                  {
  96   4                     App_Flag  = 1;
  97   4                     Foot_Led_Flag = 1;
  98   4                     ++ Foot_Led_Cnt;
  99   4                     if(Foot_Led_Cnt & 0x01)
 100   4                     {
 101   5                        Data = FOOT_LIGHT_OPEN; 
 102   5                     }
 103   4                     else 
 104   4                     {
 105   5                        Data = FOOT_LIGHT_CLOSE; 
 106   5                     }
 107   4                  }            
 108   3              }
 109   2              else if(Get_Key == MSG_KEY7_PRESS)//K3
 110   2              {
 111   3                 if(!Heat_Flag)
 112   3                 {
 113   4                     App_Flag  = 1;
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 15:21:34 PAGE 3   

 114   4                     Heat_Flag = 1;
 115   4                     ++ Heat_Cnt;
 116   4                     if(Heat_Cnt & 0x01)
 117   4                     {
 118   5                       App_Heat_Cnt1s = 0; 
 119   5                       Heat_Cnt30Min  = 0;
 120   5                       Heat_Cnt30Min_Flag = True;
 121   5                       Data = HEAT_ON;
 122   5                       LED2_SET(1);               
 123   5                     }
 124   4                     else
 125   4                     {
 126   5                       Heat_Cnt30Min_Flag = False;  
 127   5                       Data = HEAT_OFF;
 128   5                       LED2_SET(0); 
 129   5                     }
 130   4                 }            
 131   3              }
 132   2              #if 0
                      else if(Get_Key == MSG_KEY5_SHORT_PRESS)
                      {
                          if(!Foot_Led_Flag)
                          {
                             App_Flag  = 1;
                             Foot_Led_Flag = 1;
                             ++ Foot_Led_Cnt;
                             if(Foot_Led_Cnt & 0x01)
                             {
                                Data = FOOT_LIGHT_OPEN; 
                             }
                             else 
                             {
                                Data = FOOT_LIGHT_CLOSE; 
                             }
                          }
                      }
                      #endif
 151   2          }        
 152   1          /*****************************************************************************************************
             -*************************************/
 153   1          /**************************************************************三推，脚灯/复位按键复用****************
             -************************************/ 
 154   1          /*****************************************************************************************************
             -*************************************/ 
 155   1          else
 156   1          {
 157   2              if(Get_Key == MSG_KEY_NONE)
 158   2              {
 159   3                 Rev_Data_Handle();
 160   3                 if(!App_Flag)
 161   3                 {
 162   4                    Data = STOP;  
 163   4                 }
 164   3                 Mass_Flag     = 0;
 165   3                 Heat_Flag     = 0;
 166   3                 Foot_Led_Flag = 0;
 167   3              }
 168   2              else if(Get_Key == MSG_KEY1_LONGPRESS)//K7
 169   2              {
 170   3                 App_Flag  = 0;
 171   3                 Data = HEAD_UP;        
 172   3              }
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 15:21:34 PAGE 4   

 173   2              else if(Get_Key == MSG_KEY2_LONGPRESS)//K5
 174   2              {
 175   3                 App_Flag  = 0;
 176   3                 Data = HEAD_DOWN;     
 177   3              }
 178   2              else if(Get_Key == MSG_KEY3_LONGPRESS)//K4
 179   2              {
 180   3                 App_Flag  = 0;
 181   3                 Data = CLOSE;         
 182   3              }
 183   2              else if(Get_Key == MSG_KEY4_LONGPRESS)//K6
 184   2              {
 185   3                 App_Flag  = 0;
 186   3                 Data = OPEN;               
 187   3              }
 188   2              else if(Get_Key == MSG_KEY5_LONGPRESS_HD)//K1
 189   2              {
 190   3                 App_Flag  = 0;
 191   3                 Data = HOME_POSITION;         
 192   3              }
 193   2              else if(Get_Key == MSG_KEY6_LONGPRESS)//K2
 194   2              {
 195   3                 App_Flag  = 0;
 196   3                 Data = LARBUM_UP;                    
 197   3              }
 198   2              else if(Get_Key == MSG_KEY7_LONGPRESS)//K3
 199   2              {
 200   3                 App_Flag  = 0;
 201   3                 Data = LARBUM_DOWN;  
 202   3              }
 203   2              else if(Get_Key == MSG_KEY5_SHORT_PRESS)
 204   2              {
 205   3                  if(!Foot_Led_Flag)
 206   3                  {
 207   4                     App_Flag  = 1;
 208   4                     Foot_Led_Flag = 1;
 209   4                     ++ Foot_Led_Cnt;
 210   4                     if(Foot_Led_Cnt & 0x01)
 211   4                     {
 212   5                        Data = FOOT_LIGHT_OPEN; 
 213   5                     }
 214   4                     else 
 215   4                     {
 216   5                        Data = FOOT_LIGHT_CLOSE; 
 217   5                     }
 218   4                  }
 219   3              }
 220   2          }
 221   1      }
 222          
 223          
 224          void System_Init(void)
 225          {
 226   1        TimeOutDet_Init();
 227   1        Timer_Init();
 228   1        Uart_Init(9600);
 229   1        Led_App_Handle(LED_NUM);
 230   1        Test_Init();
 231   1        Key_Init();
 232   1        Key_Register(Key_Handle);
 233   1        WDTCON |= 0X40;
 234   1        EA = 1;
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 15:21:34 PAGE 5   

 235   1      }
 236          
 237          void System_Handle(void)
 238          {
 239   1         WDTCON |= 0X40;
 240   1         Key_Poll();
 241   1         if(TimeOutDet_Check(&TimeOut_Para[0]))
 242   1         {
 243   2            TimeOut_Record(&TimeOut_Para[0],OnLine_Time); 
 244   2            Protocol_Send(SEND_ADDR,SEND_ID,Data);         
 245   2         }
 246   1      }
 247          
 248          /**************************************************
 249          *函数名称：void timer0/1/2() interrupt 1/3/5
 250          *函数功能：定时器中断产生方波
 251          *入口参数：void
 252          *出口参数：void
 253          **************************************************/
 254          void timer0() interrupt 1
 255          {
 256   1        extern unsigned int Mass_Cnt;
 257   1        extern unsigned int Heat_Cnt;
 258   1        extern unsigned int Foot_Led_Cnt;
 259   1        TL0 = (65536 - 6000)%256;
 260   1        TH0 = (65536 - 6000)/256;
 261   1        TimeOutDet_DecHandle();
 262   1        /***********************马达定时关闭*************************/
 263   1        if(Mass_Cnt30Min_Flag)
 264   1        {
 265   2           App_Mass_Cnt1s ++; 
 266   2        }      
 267   1        if(App_Mass_Cnt1s > 1000)
 268   1        {
 269   2           App_Mass_Cnt1s = 0;
 270   2           Mass_Cnt30Min ++;      
 271   2        }
 272   1        if(Mass_Cnt30Min > 1800)
 273   1        {
 274   2           Mass_Cnt30Min = 0; 
 275   2           App_Mass_Cnt1s = 0;     
 276   2           Mass_Cnt30Min_Flag = False;
 277   2           Data = MASS_CLOSE;  
 278   2           LED2_SET(0);
 279   2           Mass_Cnt = 0;
 280   2        }
 281   1        /**************************发热布定时关闭************************************/
 282   1        if(Heat_Cnt30Min_Flag)
 283   1        {
 284   2          App_Heat_Cnt1s ++; 
 285   2        }
 286   1        if(App_Heat_Cnt1s > 1000)
 287   1        {
 288   2           App_Heat_Cnt1s = 0; 
 289   2           Heat_Cnt30Min ++;
 290   2        }
 291   1        if(Heat_Cnt30Min > 1800)
 292   1        {
 293   2           App_Heat_Cnt1s = 0; 
 294   2           Heat_Cnt30Min  = 0;
 295   2           Heat_Cnt30Min_Flag = False;
 296   2           Data = HEAT_OFF;
C51 COMPILER V9.59.0.0   SYSTEM                                                            11/30/2018 15:21:34 PAGE 6   

 297   2           LED1_SET(0); 
 298   2           Heat_Cnt = 0;
 299   2        }
 300   1        
 301   1      }
 302          
 303          void timer1() interrupt 3
 304          {
 305   1      
 306   1      }
 307          
 308          void Timer2Int(void) interrupt 5
 309          {               
 310   1              TF2 = 0;   //溢出清零
 311   1       
 312   1      }
 313          
 314          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    614    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     37       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
